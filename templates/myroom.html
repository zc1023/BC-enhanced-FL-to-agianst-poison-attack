<!doctype html>
<html class="x-admin-sm">
    <head>
        <meta charset="UTF-8">
        <title>Finance System</title>
        <meta name="renderer" content="webkit|ie-comp|ie-stand">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <meta http-equiv="Cache-Control" content="no-siteapp" />
        <link rel="stylesheet" href="static/css/font.css">
        <link rel="stylesheet" href="static/fontAlibaba/iconfont.css">
        <link rel="stylesheet" href="static/css/xadmin.css">
        <!-- <link rel="stylesheet" href="./css/theme5.css"> -->
        <script src="static/lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="static/js/xadmin.js"></script>
        {% if 0 == stop %}
        <meta http-equiv="refresh" content="2000;url={{ url_for('train') }}">
        {% endif %}
        <script>
            // 是否开启刷新记忆tab功能
            // var is_remember = false;
        </script>
    </head>
    <body class="index">
        <script>
            if(!window.name){
                     window.name = 'test';
                     window.location.reload();
            }
       </script>
        <!-- 顶部开始 -->
        <div class="container">
            <div class="logo">
                <a href="/home">金融风控联邦学习系统</a></div>
 
            <!-- <ul class="layui-nav left fast-add" lay-filter="">
                <li class="layui-nav-item">
                    <a href="javascript:;">+新增</a>
                    <dl class="layui-nav-child">
                        <dd>
                            <a onclick="xadmin.open('最大化','http://www.baidu.com','','',true)">
                                <i class="iconfont">&#xe6a2;</i>弹出最大化</a></dd>
                        <dd>
                            <a onclick="xadmin.open('弹出自动宽高','http://www.baidu.com')">
                                <i class="iconfont">&#xe6a8;</i>弹出自动宽高</a></dd>
                        <dd>
                            <a onclick="xadmin.open('弹出指定宽高','http://www.baidu.com',500,300)">
                                <i class="iconfont">&#xe6a8;</i>弹出指定宽高</a></dd>
                        <dd>
                            <a onclick="xadmin.add_tab('在tab打开','member-list.html')">
                                <i class="iconfont">&#xe6b8;</i>在tab打开</a></dd>
                        <dd>
                            <a onclick="xadmin.add_tab('在tab打开刷新','member-del.html',true)">
                                <i class="iconfont">&#xe6b8;</i>在tab打开刷新</a></dd>
                    </dl>
                </li>
            </ul> -->
            <ul class="layui-nav right" lay-filter="">
                <li class="layui-nav-item">
                    <a href="javascript:;">
                        <div class="lafitewu_circle">
                            <i class="iconfont">&#xe6ff;</i>
                        </div>
                        {{username}}
                    </a>
                    <!-- <dl class="layui-nav-child">
                        <dd>
                            <a onclick="xadmin.open('个人信息','http://www.baidu.com')">个人信息</a></dd>
                        <dd>
                            <a onclick="xadmin.open('切换帐号','http://www.baidu.com')">切换帐号</a></dd>
                        <dd>
                            <a href="./login.html">退出</a></dd>
                    </dl> -->
                </li>
                <li class="layui-nav-item lafitewu_exit to-index">
                    <a href="/logout"><i class="iconfont">&#xe704;</i>登出</a>
                </li>
            </ul>
        </div>
        <!-- 顶部结束 -->
        <!-- 中部开始 -->
        <!-- 左侧菜单开始 -->
        <div class="left-nav">
            <div id="side-nav">
                <ul id="nav">
                    <li>
                        <a  href="/create" >
                            <i class="iconfont left-nav-li" lay-tips="模型训练">&#xe702;</i>
                            <cite>创建房间</cite>
                        </a>
                    </li>                    
                    <li>
                        <a  href="/train" >
                            <i class="iconfont left-nav-li" lay-tips="模型训练">&#xe702;</i>
                            <cite>加入房间</cite>
                        </a>
                    </li>
                    <li>
                        <a  href="/myroom" >
                            <i class="iconfont left-nav-li" lay-tips="模型训练">&#xe702;</i>
                            <cite>我的房间</cite>
                        </a>
                    </li>
                    <li>
                        <a  href="/info" >
                            <i class="iconfont left-nav-li" lay-tips="个人信息">&#xe702;</i>
                            <cite>个人信息</cite>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- <div class="x-slide_left"></div> -->
        <!-- 左侧菜单结束 -->
        <!-- 右侧主体开始 -->
        <div class="page-content">
            <div class="layui-tab tab" lay-filter="xbs_tab" lay-allowclose="false">
                <ul class="layui-tab-title">
                    <li class="home">
                        <!-- <i class="layui-icon">&#xe68e;</i>我的桌面 -->
                        我的房间
                    </li>
                </ul>


                <div class="layui-tab-content">
                    <div class="layui-fluid">
                        <div class="layui-row layui-col-space15">
                            <div class="layui-col-md12">
                                <div class="layui-card">
                                    {% if is_in_room %}
                                    <div class="layui-input-inline lafite_search layui-show-xs-block">
                                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 0px;">
                                            <legend>当前房间号: JXWh5F32nyRU6fZmekt7VY</legend>
                                        </fieldset>
                                    {% if is_admin %}
                                    <form action="/myroom" method="post">
                                        <button class="layui-btn" id="loadClient" type="submit">开始训练</button>
                                    </form>
                                    
                                    {% else %}
                                    <button class="layui-btn disabled-button" id="loadClient" action="/myroom" disabled>
                                        开始训练
                                    </button>
                                    {% endif %}
                                </div> 
                                <div class="layui-progress custom-progress" lay-filter="demo" lay-showPercent="true" id="myProgressBar">
                                    <div class="layui-progress-bar" lay-percent="0%"></div>
                                </div>
                                {% if stop %}

                                <p id="progressText">Epoch: 0/10</p>
                                <p id="timeElapsed">已用时间: 00:00</p>
                                <p id="timeRemaining">预计剩余时间: 01:03</p>
                                <p class="progress-label">训练进度</p>
                                {% endif %}
                                    <div class="layui-card-body">
                                        <div class="layui-row layui-col-space15" id="clientsCards">
                                            <!-- {% for clients in client_data %}
        
                                            <div class="layui-col-md4">
                                                <div class="layui-card">
                                                  <div class="layui-card-header">客户端ID: {{clients[0]}} </div>
                                                  <div class="layui-card-header">客户端名称: {{clients[1]}} </div>
                                                  <div class="layui-card-header">数据地址: {{clients[2]}} </div>
                                                  <div class="layui-card-body">
                                                    
                                                  </div>
                                                </div>
                                            </div>
                                            {% endfor %} -->
                                            <table class="layui-table">
                                                <colgroup>
                                                    <col width="250">
                                                    <col width="200">
                                                    <col>
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th>客户端ID</th>
                                                        <th>客户端名称</th>
                                                        <th>数据地址</th>
                                                        <th>区块链账户地址</th>
                                                    </tr> 
                                                </thead>
                                                <tbody id="clientsTBody">
                                                    {% for clients in client_list %}
                                                        <tr>
                                                            <td>{{clients[0]}}</td>
                                                            <td>{{clients[1]}}</td>
                                                            <td>{{clients[2]}}</td>
                                                            <td>{{clients[3]}}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                            
                                        </div>
                                    </div>
                                    {% else %}
                                    您还没有加入任何房间
                                    {% endif %}
                                        <script>
                                            // function sleep(millisecond) {
                                            //     return new Promise(resolve => {
                                            //         setTimeout(() => {
                                            //         resolve()
                                            //         }, millisecond)
                                            //     });
                                            // }

                                            function dele(id){
                                              layui.use('layer',function(){
                                                  var layer = layui.layer;
                                                    layer.msg('你确定删除么？', {
                                                    btn: ['确定', '取消'],
                                                    yes: function(index){
                                                        console.log(id);
                                                        $.ajax({
                                                            url:"/train_delete",
                                                            data:{'id':id},
                                                            type:"Post",
                                                            dataType:"json",
                                                            success: function (res) {
                                                                if(res.state == 'yes'){
                                                                    parent.location.replace("/new");
                                                                }
                                                                if(res.state == 'no'){
                                                                    alert("此客户存在关联账户，不允许删除！")
                                                                }
                                                                if(res.state == 'nol'){
                                                                    alert("此客户存在贷款，不允许删除！")
                                                                }
                                                            }
                                                        
                                                        });
                                                        layer.close(index);
                                                    },
                                                });
                                                
                                              });
                                              
                                          };
                                          
                                        </script>
                                    
                                    </div> 
                                    <!-- <div class="layui-card-body ">
                                        <div class="page">
                                            <div>
                                                <a class="prev" href="">&lt;&lt;</a>
                                                <a class="num" href="">1</a>
                                                <span class="current">2</span>
                                                <a class="num" href="">3</a>
                                                
                                                <a class="next" href="">&gt;&gt;</a></div>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>


                <div id="tab_show"></div>


            </div>
        </div>
        <div class="page-content-bg"></div>

        <style id="theme_style">
                .custom-progress {
        margin-top: 20px;
        margin-bottom: 20px;
    }

.page-content {
    overflow-y: auto;  /* 只在Y轴上滚动 */
    height: 100vh;     /* 使高度等于视口高度 */
}
.layui-tab-content{
    overflow-y: auto;  /* 只在Y轴上滚动 */
    height: 100vh;     /* 使高度等于视口高度 */
}
.disabled-button {
    background-color: gray !important;  /* 使用 !important 以确保覆盖其他样式 */
    cursor: not-allowed;
}
.layui-table td, .layui-table th {
    font-size: 14px; 
    padding: 5px;
}
    .progress-label {
    text-align: center;
    color: #666;
    margin-bottom: 20px;
}
        </style>
        <!-- 右侧主体结束 -->
        <!-- 中部结束 -->
    </body>
</html>
<script>


layui.use(['laydate', 'form', 'upload'],
        function() {
            var $ = layui.jquery
            
            $(".layui-tab-title li").click(function() {
                console.log($(this));
            });
        });

// layui.use(['jquery'], function() {
//             var $ = layui.jquery;
            
//             $('#loadClient').click(function() {
//                 $.get("/join", function() {
//                 });
//             });
//         });

// layui.use(['jquery', 'element', 'layer'], function() {
//     var $ = layui.jquery;
//     var element = layui.element;
//     var layer = layui.layer;
//     $('#loadClient').click(function() {
//         layer.prompt({title: '请输入数据地址', formType: 2}, function(dataAddress, index){
//         layer.close(index);
//         $.ajax({
//             url: '/join',
//             method: 'GET',
//             data: { address: dataAddress },
//             // success: function(data) {
//             //     var content = '<div class="layui-col-md4">' +
//             //                       '<div class="layui-card">' +
//             //                         '<div class="layui-card-header">' + '客户端ID: ' + data.client_id + '</div>'+
//             //                         '<div class="layui-card-header">' + '客户端名称: '+ data.client + '</div>'+
//             //                         '<div class="layui-card-header">' + '数据地址: '+ data.data_address + '</div>' +
//             //                         '<div class="layui-card-body">' +

//             //                         '</div>' +
//             //                       '</div>' +
//             //                   '</div>';

//             //     $('#clientsCards').append(content);
//             // },
//             success: function(data) {
//             var newRow = '<tr>' +
//                  '<td>' + data.client_id + '</td>' +
//                  '<td>' + data.client + '</td>' +
//                  '<td>' + data.data_address + '</td>' +
//                  '</tr>';
    
//             $('#clientsTBody').append(newRow);
//         },
//             error: function() {
//                 alert("加载数据失败!");
//             }
//         });
//     });
// });
// });

layui.use(['element', 'layer'], function(){
    var element = layui.element;
    var layer = layui.layer;
    var progress = 0;
    var totalTime = 63;  
    var elapsedTime = 0;
    var epochsCompleted = 0;
    var epochDurations = [4, 7, 6, 5, 8, 7, 6, 6, 7, 7];

    function updateTimer() {
        var elapsedMinutes = Math.floor(elapsedTime / 60);
        var elapsedSeconds = Math.floor(elapsedTime % 60);
        document.getElementById("timeElapsed").innerText = "已用时间: " + (elapsedMinutes < 10 ? "0" : "") + elapsedMinutes + ":" + (elapsedSeconds < 10 ? "0" : "") + elapsedSeconds;

        var remainingTime = totalTime - elapsedTime;
        var remainingMinutes = Math.floor(remainingTime / 60);
        var remainingSeconds = Math.floor(remainingTime % 60);
        document.getElementById("timeRemaining").innerText = "预计剩余时间: " + (remainingMinutes < 10 ? "0" : "") + remainingMinutes + ":" + (remainingSeconds < 10 ? "0" : "") + remainingSeconds;

        document.getElementById("progressText").innerText = "Epoch: " + epochsCompleted + "/10";
    }

    function stallProcedure() {
        totalTime += 3;  // Immediately add 2 seconds to total time
        updateTimer();

        setTimeout(function() {
            var randomReduction = (Math.random() < 0.5) ? 1 : 1.5;
            totalTime -= randomReduction;  // Reduce total time by either 1 or 2 seconds
            updateTimer();
        }, 2000);  // 4 seconds after stalling
    }

    function increaseProgress() {
        if (epochsCompleted < 10) {
            var currentDuration = epochDurations[epochsCompleted];
            var intervalCount = currentDuration * 10; 
            var progressIncrement = 10 / intervalCount;  

            var intervalId = setInterval(function() {
                progress += progressIncrement;
                elapsedTime += 0.1;
                updateTimer();
                element.progress('demo', progress.toFixed(2) + '%');

                if (elapsedTime >= (epochDurations.slice(0, epochsCompleted + 1).reduce((a, b) => a + b, 0))) {
                    clearInterval(intervalId);
                    // Introducing stall before increasing the epoch
                    if (Math.random() < 0.5) {  // 50% chance to stall at epoch increment
                        stallProcedure();
                        setTimeout(() => {
                            epochsCompleted += 1;
                            increaseProgress();
                        }, 2000);  
                    } else {
                        epochsCompleted += 1;
                        increaseProgress();
                    }
                }
            }, 100);
        } 

        if (epochsCompleted == 10) {
            progress = 100;
            element.progress('demo', '100%');  
            updateTimer();
            document.getElementById("timeRemaining").innerText = "预计剩余时间: 00:00";
            showIpfsAddress();
        }
    }

    function showIpfsAddress() {
        var ipfsAddress = "{{ipfs}}";
        layer.open({
            title: '训练完成',
            content: 'IPFS地址是: ' + ipfsAddress
        });
    }

    var is_train = {{ stop|tojson|safe }};
    if(is_train){
        increaseProgress(); 
    }
});








// layui.use('element', function(){
//     var element = layui.element;

//     // 示例数据
//     var data = [
//         {client: 'Client1', progress: 30},
//         {client: 'Client2', progress: 50},
//         //...
//     ];

//     // 动态生成卡片内容
//     var content = '';
//     data.forEach(function(item){
//         content += '<div class="layui-col-md4">' +
//                       '<div class="layui-card">' +
//                         '<div class="layui-card-header">' + item.client + '</div>' +
//                         '<div class="layui-card-body">' +
//                           '<div class="layui-progress"><div class="layui-progress-bar" lay-percent="' + item.progress + '%"></div></div>' +
//                         '</div>' +
//                       '</div>' +
//                    '</div>';
//     });

//     document.getElementById('clientsCards').innerHTML = content;
//     element.render('progress');
// });


    </script>